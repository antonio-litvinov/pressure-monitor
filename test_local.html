<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¶–∏—Ñ—Ä–æ–≤–æ–π —Ç–æ–Ω–æ–º–µ—Ç—Ä - –õ–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü©∫ <span class="ai">–¶–∏—Ñ—Ä–æ–≤–æ–π-</span><span class="assistant">—Ç–æ–Ω–æ–º–µ—Ç—Ä</span></h1>
            <p>–ò–∑–º–µ—Ä–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è –ø–æ –≤–∏–¥–µ–æ —Å –ø–æ–º–æ—â—å—é –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞</p>
        </div>

        <div class="video-section">
            <div class="video-preview" id="videoPreview">
                <div style="text-align: center; color: #999999;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üìπ</div>
                    <div>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è —Å—ä–µ–º–∫–∏</div>
                    <div style="font-size: 12px; margin-top: 10px; opacity: 0.7;">
                        –ó–∞–ø–∏—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
                    </div>
                </div>
            </div>

            <div class="timer hidden" id="timer">‚è±Ô∏è –û—Å—Ç–∞–ª–æ—Å—å: 10 —Å–µ–∫</div>

            <button class="record-button" id="recordButton">
                üé• –ù–∞—á–∞—Ç—å —Å—ä–µ–º–∫—É
            </button>

            <div class="controls hidden" id="controls">
                <button class="control-button primary" id="sendButton">
                    üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –∞–Ω–∞–ª–∏–∑
                </button>
            </div>
        </div>

        <div class="status hidden" id="status"></div>
    </div>

    <script>
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        const VIDEO_MIME_TYPE = 'video/webm';
        const RECORDING_DURATION = 10; // —Å–µ–∫—É–Ω–¥
        
        const ERROR_MESSAGES = {
            NotAllowedError: '–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.',
            NotFoundError: '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.',
            NotReadableError: '–ö–∞–º–µ—Ä–∞ –∑–∞–Ω—è—Ç–∞ –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º. –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.',
            NotSupportedError: '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ.',
            OverconstrainedError: '–ö–∞–º–µ—Ä–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.'
        };
        
        const DEFAULT_PRESSURE = {
            systolic: '120',
            diastolic: '80',
            category: '–ù–æ—Ä–º–∞–ª—å–Ω–æ–µ'
        };
        
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API —Å–µ—Ä–≤–µ—Ä–∞
        let SERVER_CONFIG = {
            baseUrl: 'https://api.pressure-monitor.ru',
            endpoints: {
                processVideo: '/api/process-video'
            }
        };

        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const videoPreview = document.getElementById('videoPreview');
        const recordButton = document.getElementById('recordButton');
        const timer = document.getElementById('timer');
        const controls = document.getElementById('controls');
        const sendButton = document.getElementById('sendButton');
        const status = document.getElementById('status');

        let mediaRecorder;
        let recordedChunks = [];
        let stream;
        let timerInterval;
        let recordingTime = 0;

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞
        function logServerConfig() {
            console.log('API —Å–µ—Ä–≤–µ—Ä:', SERVER_CONFIG.baseUrl);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
        function showStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
            status.classList.remove('hidden');
            setTimeout(() => {
                status.classList.add('hidden');
            }, 5000);
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä
        function updateTimer() {
            const remaining = RECORDING_DURATION - recordingTime;
            timer.textContent = `‚è±Ô∏è –û—Å—Ç–∞–ª–æ—Å—å: ${remaining} —Å–µ–∫`;
            
            if (remaining <= 0) {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    clearInterval(timerInterval);
                    
                    recordButton.classList.remove('recording');
                    recordButton.disabled = false; // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ–±—Ä–∞—Ç–Ω–æ
                    timer.classList.add('hidden');
                    videoPreview.classList.remove('recording');
                    
                    showStatus('‚èπÔ∏è –ó–∞–ø–∏—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'info');
                }
            }
        }

        // –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ
        async function getCameraAccess() {
            try {
                showStatus('üîç –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...', 'info');
                
                const constraints = {
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }, 
                    audio: true 
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const video = document.createElement('video');
                video.srcObject = stream;
                video.autoplay = true;
                video.muted = true;

                videoPreview.innerHTML = '';
                videoPreview.appendChild(video);
                
                showStatus('‚úÖ –ö–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∑–∞–ø–∏—Å–∏', 'success');
                recordButton.disabled = false;
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', err);
                
                const errorMessage = ERROR_MESSAGES[err.name] || err.message || '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ';
                showStatus(`‚ùå ${errorMessage}`, 'error');
            }
        }

        // –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
        async function startRecording() {
            if (!stream) {
                showStatus('‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ', 'error');
                return;
            }

            recordedChunks = [];
            recordingTime = 0;
            
            if (!MediaRecorder.isTypeSupported(VIDEO_MIME_TYPE)) {
                showStatus('‚ùå –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ webm', 'error');
                return;
            }

            try {
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: VIDEO_MIME_TYPE
                });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: VIDEO_MIME_TYPE });
                    const url = URL.createObjectURL(blob);
                    
                    const video = document.createElement('video');
                    video.src = url;
                    video.controls = true;
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.objectFit = 'cover';

                    videoPreview.innerHTML = '';
                    videoPreview.appendChild(video);
                    videoPreview.classList.remove('recording');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                    controls.classList.remove('hidden');
                    
                    showStatus('‚úÖ –ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ì–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞ –∞–Ω–∞–ª–∏–∑.', 'success');
                };

                mediaRecorder.onerror = (event) => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏:', event.error);
                    showStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ', 'error');
                };

                mediaRecorder.start(1000); // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —á–∞–Ω–∫–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
                
                recordButton.classList.add('recording');
                recordButton.disabled = true; // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏
                timer.classList.remove('hidden');
                videoPreview.classList.add('recording');
                showStatus('üé• –ò–¥–µ—Ç –∑–∞–ø–∏—Å—å...', 'recording');
                
                // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
                timerInterval = setInterval(() => {
                    recordingTime++;
                    updateTimer();
                }, 1000);
                
                updateTimer();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ MediaRecorder:', error);
                showStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏', 'error');
            }
        }

        // –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –≤–∏–¥–µ–æ
        function generateVideoFilename() {
            const timestamp = getCurrentTimestamp();
            return `pressure_video_${timestamp}.webm`;
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π timestamp –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
        function getCurrentTimestamp() {
            return new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        }

        // –ü–æ–ª—É—á–∏—Ç—å –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        function getErrorMessage(error) {
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                return '–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä.';
            } else if (error.message.includes('HTTP 404')) {
                return '–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥—Ä–µ—Å –∏ –ø–æ—Ä—Ç.';
            } else if (error.message.includes('HTTP 500')) {
                return '–û—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞.';
            } else {
                return error.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∏–¥–µ–æ';
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∏–¥–µ–æ –Ω–∞ –∞–Ω–∞–ª–∏–∑
        async function sendVideo() {
            if (recordedChunks.length === 0) {
                showStatus('‚ùå –ù–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ', 'error');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º Blob –≤ —Ñ–æ—Ä–º–∞—Ç–µ webm
            const blob = new Blob(recordedChunks, { type: VIDEO_MIME_TYPE });
            
            if (blob.size === 0) {
                showStatus('‚ùå –í–∏–¥–µ–æ –ø—É—Å—Ç–æ–µ (0 –±–∞–π—Ç)', 'error');
                return;
            }
            
            try {
                showStatus('üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –≤–∏–¥–µ–æ –Ω–∞ –∞–Ω–∞–ª–∏–∑...', 'uploading');
                
                const apiUrl = SERVER_CONFIG.baseUrl + SERVER_CONFIG.endpoints.processVideo;
                
                const formData = new FormData();
                const filename = generateVideoFilename();
                formData.append('video', blob, filename);
                formData.append('timestamp', new Date().toISOString());
                formData.append('user_id', 'web_user');
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success) {
                        showStatus('‚úÖ –í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ!', 'success');
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        setTimeout(() => {
                            showPressureResult(result);
                        }, 1000);
                    } else {
                        throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                    }
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                
                const errorMessage = getErrorMessage(error);
                showStatus(`‚ùå ${errorMessage}`, 'error');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑–º–µ—Ä–µ–Ω–∏—è –¥–∞–≤–ª–µ–Ω–∏—è
        function showPressureResult(result) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result-section';
            
            // –ü–∞—Ä—Å–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –¥–∞–≤–ª–µ–Ω–∏–∏)
            const pressureData = result.data || {};
            const systolic = pressureData.systolic || DEFAULT_PRESSURE.systolic;
            const diastolic = pressureData.diastolic || DEFAULT_PRESSURE.diastolic;
            const category = pressureData.category || DEFAULT_PRESSURE.category;
            
            resultDiv.innerHTML = `
                <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑–º–µ—Ä–µ–Ω–∏—è</h3>
                <div class="pressure-result">
                    <div class="pressure-value">${systolic}/${diastolic}</div>
                    <div class="pressure-category">${category}</div>
                    <div style="margin-top: 15px; font-size: 14px; color: #666666;">
                        <p><strong>–í—Ä–µ–º—è –∏–∑–º–µ—Ä–µ–Ω–∏—è:</strong> ${new Date().toLocaleTimeString()}</p>
                        <p><strong>–ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ:</strong> ${result.quality || '–•–æ—Ä–æ—à–µ–µ'}</p>
                        <p><strong>–§–∞–π–ª:</strong> ${result.filename || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                        <p><strong>–†–∞–∑–º–µ—Ä:</strong> ${result.size ? (result.size / 1024).toFixed(1) + ' –ö–ë' : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                    </div>
                </div>
                <button class="control-button primary" onclick="resetApp()">
                    üé¨ –ù–æ–≤–æ–µ –∏–∑–º–µ—Ä–µ–Ω–∏–µ
                </button>
            `;
            
            // –ó–∞–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            document.querySelector('.container').innerHTML = '';
            document.querySelector('.container').appendChild(resultDiv);
        }

        // –°–±—Ä–æ—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function resetApp() {
            location.reload();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        recordButton.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                // –í–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ –∫–Ω–æ–ø–∫–∞ –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç
                return;
            } else {
                startRecording();
            }
        });

        sendButton.addEventListener('click', sendVideo);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            getCameraAccess();
        });

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        showStatus('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ', 'info');
        logServerConfig();
    </script>
</body>
</html>
